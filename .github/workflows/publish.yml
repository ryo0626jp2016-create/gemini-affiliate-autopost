name: publish

on:
  schedule:
    # UTCで 0,3,6,9,12時 → JSTで 9,12,15,18,21
    - cron: "0 0,3,6,9,12 * * *"
  workflow_dispatch: {}

jobs:
  autopost:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show files (debug)
        run: |
          echo "PWD=$(pwd)"
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          ls -R .

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r "$GITHUB_WORKSPACE/requirements.txt"

      # ここが今回のエラー原因だったので修正
      - name: Gemini sanity check
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # あれば secrets 側を優先、なければ動作確認しやすい名前に
          GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}
        run: |
          python - <<'PY'
          import os
          import google.generativeai as genai

          api_key = os.getenv("GEMINI_API_KEY")
          if not api_key:
              raise SystemExit("GEMINI_API_KEY が設定されていません。GitHub Secrets に入れてください。")

          # secretsにあればそれ、なければこのモデルにする
          model = (os.getenv("GEMINI_MODEL") or "gemini-1.5-flash-001").strip()

          # ここで設定
          genai.configure(api_key=api_key)

          print("[check] model =", model)
          model_obj = genai.GenerativeModel(model)

          # ごく短いプロンプトで確認
          resp = model_obj.generate_content("health blog article")
          text = getattr(resp, "text", "") or ""
          print("[check] ok, got chars:", len(text))
          PY

      - name: Run scheduler
        env:
          WP_BASE_URL2: ${{ secrets.WP_BASE_URL2 }}
          WP_USER: ${{ secrets.WP_USER }}
          WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}  # ここもsecretに合わせておく
          A8_APP_ID: ${{ secrets.A8_APP_ID }}
          MOSHIMO_AFFILIATE_ID: ${{ secrets.MOSHIMO_AFFILIATE_ID }}
          VALUECOMMERCE_SID: ${{ secrets.VALUECOMMERCE_SID }}
          VALUECOMMERCE_PID: ${{ secrets.VALUECOMMERCE_PID }}
        run: |
          # ここが元のコードだとおそらく動かないので普通の実行にする
          # プロジェクト構成が /scripts/scheduler.py の想定
          python scripts/scheduler.py
