name: publish

on:
  schedule:
    # UTC 0,3,6,9,12 → JST 9,12,15,18,21
    - cron: "0 0,3,6,9,12 * * *"
  workflow_dispatch: {}

jobs:
  autopost:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show files (debug)
        run: |
          echo "PWD=$(pwd)"
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          ls -R .

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r "$GITHUB_WORKSPACE/requirements.txt"

      # ここが今まで落ちてたところ。固定モデル名をやめて、そのAPIキーで実際に使えるモデルを拾う。
      - name: Gemini sanity check
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}  # あればこれを優先
        run: |
          python - <<'PY'
          import os
          import google.generativeai as genai

          api_key = os.getenv("GEMINI_API_KEY")
          if not api_key:
            raise SystemExit("GEMINI_API_KEY が設定されていません。GitHub Secrets に入れてください。")

          genai.configure(api_key=api_key)

          # まず利用可能なモデルを一覧する
          models = list(genai.list_models())
          # generateContent ができるものだけに絞る
          content_models = [
              m.name for m in models
              if "generateContent" in getattr(m, "supported_generation_methods", [])
          ]

          # secrets で明示されてる → それを使う
          env_model = os.getenv("GEMINI_MODEL")
          if env_model:
            model_name = env_model.strip()
          else:
            if not content_models:
              raise SystemExit("このAPIキーで generateContent できるモデルが見つかりませんでした。")
            # 一番最初のを使う（例: models/gemini-2.5-flash みたいなのが来るはず）
            model_name = content_models[0]

          print("[check] model =", model_name)

          # list_models() は "models/..." で返すので、末尾だけにしておく
          short_name = model_name.split("/")[-1]

          model = genai.GenerativeModel(short_name)
          resp = model.generate_content("ping")
          text = getattr(resp, "text", "") or ""
          print("[check] ok, got chars:", len(text))
          PY

      - name: Run scheduler
        env:
          WP_BASE_URL2: ${{ secrets.WP_BASE_URL2 }}
          WP_USER: ${{ secrets.WP_USER }}
          WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}
          A8_APP_ID: ${{ secrets.A8_APP_ID }}
          MOSHIMO_AFFILIATE_ID: ${{ secrets.MOSHIMO_AFFILIATE_ID }}
          VALUECOMMERCE_SID: ${{ secrets.VALUECOMMERCE_SID }}
          VALUECOMMERCE_PID: ${{ secrets.VALUECOMMERCE_PID }}
        run: |
          # scripts/scheduler.py があるのはさっきの ls で確認できてるのでこれでOK
          python scripts/scheduler.py


